---
---

\tikzset{every function node/.style={
    inner xsep=.1\masterunit,
    /function/.cd,
    west io=1,
    north io=2,
    south io=0,
}}

\matrix (A) [collection] {
    \node (a1) {$a_1$}; &
    \node [elements between]; &
    \node (ai) {$a_i$}; &
    \node [elements between]; &
    \node (an-1) {$a_{n-1}$}; &
    \node (an) {$a_n$}; &
\\ };

\foreach \i in {n-1,i,1}{
    \node (f\i) [subfunction, below=1 of a\i, anchor=north io 1] {\texttt{op}};
    \draw [flow ->] (a\i) -- (f\i.north io 1);
}

\node (b) [element, left=.5 of f1] {$b$};

\draw [flow] (fn-1.west io 1) -| ++(-.25, 0.75) coordinate (flowy);
\draw [flow, solid dashed solid] (flowy) -- (flowy -| fi.north io 2) coordinate (last);
\draw [flow ->] (last) -- (fi.north io 2);

\draw [flow] (fi.west io 1) -| ++(-.25, 0.75) coordinate (last);
\draw [flow, solid dashed solid] (last) -- (last -| f1.north io 2) coordinate (last);
\draw [flow ->] (last) -- (f1.north io 2);


\draw [flow ->] (an.south) |- (flowy -| fn-1.north io 2) -- (fn-1.north io 2);

\draw [flow ->] (f1.west io 1) -- (b);
