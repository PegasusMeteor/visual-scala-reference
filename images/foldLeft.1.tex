---
---

\tikzset{op/.style={
    subfunction,
    inner xsep=.1\masterunit,
    /function/north io=2,
    /function/north io sep=.1\masterunit,
}}

\tikzset{opl/.style={
    op,
    /function/east io=1,
    /function/south io=0,
}}

\matrix (A) [collection] {
    \node (a1) {$a_1$}; &
    \node (a2) {$a_2$}; &
    \node [elements between]; &
    \node (ai) {$a_i$}; &
    \node [elements between]; &
    \node (an) {$a_n$}; &
\\ };

\foreach \i/\op in {1/opl,2/opl,i/opl,n/op}{
    \node (f\i) [\op, below=1 of a\i, anchor=north io 2] {\texttt{op}};
    \draw [flow ->] (a\i) -- (f\i.north io 2);
}

\coordinate (x) at ($ (f1.north io 1)!.5!(a1.south) $);
\coordinate (rule) at (f1.north io 1 |- x);

\draw [flow ->] (f1.east io 1) -- ($ (f1.east)!.5!(f2.west) $) -- (\currentcoordinate |- rule) -| (f2.north io 1);
\draw [flow ->, dashed] (f2.east io 1) -- ++(.25, 0) -- (\currentcoordinate |- rule) -- +(.5, 0);
\draw [<- flow, dashed] (fi.north io 1) -- (fi.north io 1 |- rule) -- +(-.5, 0);
\draw [flow ->, dashed] (fi.east io 1) -- ++(.25, 0) -- (\currentcoordinate |- rule) -- +(.5, 0);
\draw [<- flow, dashed] (fn.north io 1) -- (fn.north io 1 |- rule) -- +(-.5, 0);

\draw [<- flow] (f1.north io 1) -- +(0, .5)
    node [element, above] {\texttt{z}};
\draw [flow ->] (fn.south io 1) -- +(0, -.5)
    node [element, below] {$b$};
