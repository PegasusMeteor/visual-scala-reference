---
---

\tikzset{fun collection/.style={
    collection,
    nodes={
        minimum width=1.25\masterunit,
        minimum height=1.25\masterunit,
    }
}}

\tikzset{fun/.style={
    function,
    minimum width=.5\masterunit,
    minimum height=.5\masterunit,
}}

\matrix (A) [fun collection] {
    \node (ph1) {}; &
    \node (ph2) {}; &
    \elementsbetween &
    \node (phn) {}; &
\\ };

\node at (ph1) (f1) [fun] {$f_1$};
\node at (ph2) (f2) [fun] {$f_2$};
\node at (phn) (fn) [fun] {$f_n$};

\foreach \i in {1,2,n}{
    \draw [inverse flow] (f\i.north io 1) -- +(0, .5)
        node [element, above] {$x_\i$};
    \draw [flow] (f\i.south io 1) -- +(0, -.5)
        node [element, below] {$x^\prime_\i$};
}

\node (f1) [fun, right=3 of A] {$f_1$};
\node (f2) [fun, below=of f1] {$f_2$};
\node (fi) [fun, below=of f2, minimum height=1\masterunit] {};
\node (fn) [fun, below=of fi] {$f_n$};

\fill [white] ($ (fi.north west) + (-\defaultpenwidth, -.5\defaultpenwidth) $)
    rectangle ($ (fi.south east) + (\defaultpenwidth, .5\defaultpenwidth) $);
\draw [flow width, solid dashed solid]
    (fi.north west) to (fi.south west)
    (fi.north east) to (fi.south east);

\coordinate (x) at ($ (f1)!.5!(fn) $);
\node at (x) (g) [function, minimum height=4\masterunit, minimum width=1.25\masterunit] {};

\draw [inverse flow] (f1.north io 1) -- (g.north io 1) -- +(0, .5)
    node [element, above] {$x$};
\draw [flow] (fn.south io 1) -- (g.south io 1) -- +(0, -.5)
    node [element, below] {$x^\prime$};

\coordinate (x) at ($ (g.west)!.5!(A.east) $);
\coordinate (y) at (A.east -| x);
\node at (y) [big arrow];
