---
---

\matrix (A) [collection] {
    \elementsbefore &
    \node (ai) {$a_i$}; &
    \elementsbetween[.5] &
    \node (ai+m) {$a_{i + m}$}; &
    \elementsbetween &
    \node (aj) {$a_j$}; &
    \elementsbetween[.5] &
    \node (aj+m) {$a_{j + m}$}; &
    \elementsafter &
\\ };

\matrix (B) [collection, below=3 of A] {
    \node (bi) {$a_i$}; &
    \elementsbetween[.5] &
    \node (bi+m) {$a_{i + m}$}; &
\\ };

\foreach \i in {i,j}{
    \braceflow[-.2]{(a\i.south west)}{(a\i+m.south east)}
    \coordinate (brace\i) at (lastbrace);
}

\braceflow{(bi.north west)}{(bi+m.north east)}

\coordinate (x) at ($ (bracei)!.33!(lastbrace) $);
\coordinate (rule) at (bracei |- x);

\foreach \i/\r in {j/\neq,i/=}{
    \node (eq\i) at (brace\i |- rule)
        [minimum size=.4\masterunit, circle, draw, flow width, fill=white] {$\r$};
}

\coordinate (x) at ($ (eqi)!.5!(lastbrace) $);
\coordinate (rule) at (eqi |- x);

\foreach \i in {j,i}{
    \draw [flow width] (brace\i) -- (eq\i);
    \draw [flow width] (eq\i) -- (eq\i |- rule) -| (lastbrace);
}

% \path [draw=none, name path=p1] (brace1) -- +(0, -1);
% % \path [draw=none, name path=p2] ($ (a2.south west) + (0, -.8) $) -- +(5, 0);

% % \path [name intersections={of=p1 and p2, by={a}}] (a) pic [rotate=90] {bridge flow};
% \draw [flow width] ($ (a) + (-.5, 0) $) -- +(1, 0);

\draw [inverse flow] (eqj.east) -- +(.5, 0);
\draw [flow, solid dashed solid] (eqj) -- (eqi);
\node (b) at (ai |- B) [element] {$i$};
\draw [flow] (ai) -- (b);
