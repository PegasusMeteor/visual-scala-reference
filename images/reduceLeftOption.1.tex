---
---

\tikzset{every function node/.style={
    inner xsep=.1\masterunit,
    /function/.cd,
    east io=1,
    north io=2,
    south io=0,
}}

\matrix (A) [collection] {
    \node (a1) {$a_1$}; &
    \node (a2) {$a_2$}; &
    \node (a3) {$a_3$}; &
    \node [elements between]; &
    \node (ai) {$a_i$}; &
    \node [elements between]; &
    \node (an) {$a_n$}; &
\\ };

\foreach \i in {2,3,i,n}{
    \node (f\i) [subfunction, below=1 of a\i, anchor=north io 2] {\texttt{op}};
    \draw [flow ->] (a\i) -- (f\i.north io 2);
}

\coordinate (rule) at ($ (f2.north io 1)!.5!(a2.south) $);
\draw [flow ->] (a1) |- (f2.north io 1 |- rule) -- (f2.north io 1);

\draw [flow ->] (f2.east io 1) -- ($ (\currentcoordinate)!.5!(f3.west) $)
    |- (\currentcoordinate |- rule) -| (f3.north io 1);

\foreach \i/\j in {3/i, i/n}{
    \draw [flow ->, dashed] (f\i.east io 1) -- ++(.25, 0)
        -- (\currentcoordinate |- rule) -- +(.25, 0);
    \draw [<- flow, dashed] (f\j.north io 1) -- (\currentcoordinate |- rule) -- +(-.25, 0);
}

\draw [flow ->] (fn.east io 1) -| +(.25, -1)
    node [some={$b$}, below];
