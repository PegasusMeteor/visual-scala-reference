---
---

\tikzset{op/.style={
    subfunction,
    inner xsep=.1\masterunit,
    /function/.cd,
    east io=1,
    north io=2,
    north io sep=.1\masterunit,
    south io=0,
    /tikz/.cd,
}}

\matrix (A) [collection] {
    \node (a1) {$a_1$}; &
    \node (a2) {$a_2$}; &
    \node (a3) {$a_3$}; &
    \elementsbetween &
    \node (an) {$a_n$}; &
\\ };

\foreach \i in {2,3,n}{
    \node (f\i) [op, below=1 of a\i.south, anchor=north io 2] {\texttt{op}};
    \draw [flow ->] (a\i) -- (f\i.north io 2);
}

\draw [flow ->] (a1.south) -- ++(0, -.5) coordinate (rule) -| (f2.north io 1);
\draw [flow ->] (f2.east io 1) -- ++(.125, 0) coordinate (x) -- (rule -| x) -| (f3.north io 1);
\draw [flow, dashed] (f3.east io 1) -- ++(.125, 0) coordinate (x) -- (rule -| x) -- +(.5, 0);
\draw [<- flow, dashed] (fn.north io 1) coordinate (x) -- (rule -| x) -- +(-.5, 0);

\node (b) [some={$b$}, right=1 of fn];
\draw [flow ->] (fn.east io 1) -- (b);
