\makeatletter

\pgfkeys{
    /function/.cd,
    north port/.initial=1,
    south port/.initial=1,
    east port/.initial=0,
    west port/.initial=0,
    port width/.initial=3mm,
    port sep/.initial=1mm,
    north port width/.initial=\expandafter\pgfkeysvalueof{/function/port width},
    north port sep/.initial=\expandafter\pgfkeysvalueof{/function/port sep},
    south port width/.initial=\expandafter\pgfkeysvalueof{/function/port width},
    south port sep/.initial=\expandafter\pgfkeysvalueof{/function/port sep},
    east port height/.initial=\expandafter\pgfkeysvalueof{/function/port width},
    east port sep/.initial=\expandafter\pgfkeysvalueof{/function/port sep},
    west port height/.initial=\expandafter\pgfkeysvalueof{/function/port width},
    west port sep/.initial=\expandafter\pgfkeysvalueof{/function/port sep},
}

\def\port#1{
    \pgfpathlineto{\pgfqpoint{\z@}{\z@}}
    \pgfpathlineto{\pgfqpoint{.5mm}{\z@}}
    \pgfpathlineto{\pgfqpoint{.5mm}{.5mm}}
    \pgfpathlineto{\pgfqpoint{\z@}{1mm}}
    \pgfpathlineto{\pgfqpoint{\z@}{1.5mm}}
    \pgfpathlineto{\pgfqpoint{#1}{1.5mm}}
    \pgfpathlineto{\pgfqpoint{#1}{1mm}}
    \pgfpathlineto{\pgfpoint{#1 - .5mm}{.5mm}}
    \pgfpathlineto{\pgfpoint{#1 - .5mm}{\z@}}
    \pgfpathlineto{\pgfqpoint{#1}{\z@}}
}

\pgfdeclareshape{function}{%
    \inheritsavedanchors[from=rectangle]
    \inheritanchor[from=rectangle]{north east}
    \inheritanchor[from=rectangle]{north west}
    \inheritanchor[from=rectangle]{south east}
    \inheritanchor[from=rectangle]{south west}
    \savedanchor\southwest{%
        % box width
        \pgf@x=\the\wd\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerxsep}
        \advance\pgf@x by 2\pgf@xa%
        % is width < min width?
        \setlength\pgf@xa{\pgfshapeminwidth}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < north port width
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port width} + \pgfkeysvalueof{/function/north port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/north port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < south port width
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/south port width} + \pgfkeysvalueof{/function/south port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/south port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % + outer sep
        \setlength\pgf@xa{\pgfshapeouterxsep}%
        %
        \advance\pgf@x by 2\pgf@xa%
        \pgf@x = -.5\pgf@x
        \advance\pgf@x by .5\wd\pgfnodeparttextbox
        % box height
        \pgf@y=\the\ht\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@ya{\pgfshapeinnerysep}
        \advance\pgf@y by 2\pgf@ya%
        % is height < min height?
        \setlength\pgf@ya{\pgfshapeminheight}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < east port height
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port height} + \pgfkeysvalueof{/function/east port sep}}
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/east port} * \@tempdima}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < west port height
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port height} + \pgfkeysvalueof{/function/west port sep}}
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/west port} * \@tempdima}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % + outer sep
        \setlength\pgf@ya{\pgfshapeouterysep}%
        %
        \advance\pgf@y by 2\pgf@ya%
        \pgf@y = -.5\pgf@y
        \advance\pgf@y by .5\ht\pgfnodeparttextbox
    }
    \savedanchor\northeast{%
        % box width
        \pgf@x=\the\wd\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerxsep}
        \advance\pgf@x by 2\pgf@xa%
        % is width < min width?
        \setlength\pgf@xa{\pgfshapeminwidth}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < north port width
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port width} + \pgfkeysvalueof{/function/north port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/north port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < south port width
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/south port width} + \pgfkeysvalueof{/function/south port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/south port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % + outer sep
        \setlength\pgf@xa{\pgfshapeouterxsep}%
        %
        \advance\pgf@x by 2\pgf@xa%
        \pgf@x = .5\pgf@x
        \advance\pgf@x by .5\wd\pgfnodeparttextbox
        %
        % box height
        \pgf@y=\the\ht\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@ya{\pgfshapeinnerysep}
        \advance\pgf@y by 2\pgf@ya%
        % is height < min height?
        \setlength\pgf@ya{\pgfshapeminheight}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < east port height
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port height} + \pgfkeysvalueof{/function/east port sep}}
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/east port} * \@tempdima}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < west port height
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port height} + \pgfkeysvalueof{/function/west port sep}}
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/west port} * \@tempdima}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % + outer sep
        \setlength\pgf@ya{\pgfshapeouterysep}%
        %
        \advance\pgf@y by 2\pgf@ya%
        \pgf@y = .5\pgf@y
        \advance\pgf@y by .5\ht\pgfnodeparttextbox
    }
    \savedanchor\centerpoint{%
        \pgf@x = .5\wd\pgfnodeparttextbox
        \pgf@y = .5\ht\pgfnodeparttextbox
    }
    \saveddimen\functionwidth{%
        % box width
        \pgf@x=\the\wd\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerxsep}
        \advance\pgf@x by 2\pgf@xa%
        % is width < min width?
        \setlength\pgf@xa{\pgfshapeminwidth}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < north port width
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port width} + \pgfkeysvalueof{/function/north port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/north port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < south port width
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/south port width} + \pgfkeysvalueof{/function/south port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/south port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
    }
    \saveddimen\functionheight{%
        % box height
        \pgf@x=\the\ht\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerysep}
        \advance\pgf@x by 2\pgf@xa%
        % is height < min height?
        \setlength\pgf@xa{\pgfshapeminheight}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is height < east port height
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port height} + \pgfkeysvalueof{/function/east port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/east port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is height < west port height
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port height} + \pgfkeysvalueof{/function/west port sep}}
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/west port} * \@tempdima}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
    }
    \saveddimen\functionnorthportwidth{%
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port width} + \pgfkeysvalueof{/function/north port sep}}
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/north port} * \@tempdima}
    }
    \saveddimen\functionsouthportwidth{%
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/south port width} + \pgfkeysvalueof{/function/south port sep}}
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/south port} * \@tempdima}
    }
    \saveddimen\functioneastportheight{%
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port height} + \pgfkeysvalueof{/function/east port sep}}
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/east port} * \@tempdima}
    }
    \saveddimen\functionwestportheight{%
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port height} + \pgfkeysvalueof{/function/west port sep}}
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/west port} * \@tempdima}
    }
    \saveddimen\northportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/north port}>0 \advance\pgf@x by 1.5mm \fi
    }
    \saveddimen\southportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/south port}>0 \advance\pgf@x by -1.5mm \fi
    }
    \saveddimen\eastportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/east port}>0 \advance\pgf@x by 1.5mm \fi
    }
    \saveddimen\westportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/west port}>0 \advance\pgf@x by -1.5mm \fi
    }
    \anchor{center}{%
        \centerpoint
    }
    \anchor{north}{%
        \northeast \@tempdimb=\pgf@x \@tempdima=\pgf@y
        \southwest 
        \pgfmathsetlength\pgf@x{(\pgf@x + \@tempdimb) / 2}
        \pgf@y=\@tempdima
        \advance\pgf@y by \northportoffset
    }
    \anchor{south}{%
        \northeast \@tempdimb=\pgf@x
        \southwest \@tempdima=\pgf@y
        \pgfmathsetlength\pgf@x{(\pgf@x + \@tempdimb) / 2}
        \pgf@y=\@tempdima
        \advance\pgf@y by \southportoffset
    }
    \anchor{east}{%
        \southwest \@tempdima=\pgf@y
        \northeast
        \pgfmathsetlength\pgf@y{(\pgf@y + \@tempdima) / 2}
        \advance\pgf@x by \eastportoffset
    }
    \anchor{west}{%
        \northeast \@tempdima=\pgf@y
        \southwest
        \pgfmathsetlength\pgf@y{(\pgf@y + \@tempdima) / 2}
        \advance\pgf@x by \westportoffset
    }

    \anchor{north param 1}{
        \southwest \pgf@xa=\pgf@x
        \northeast \pgf@x=\pgf@xa
        \pgfmathsetlength\@tempdima{\functionwidth - \functionnorthportwidth}
        \advance\pgf@x by .5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port sep} + \pgfkeysvalueof{/function/north port width}}
        \advance\pgf@x by .5\@tempdima
        \advance\pgf@y by \northportoffset
    }
    \anchor{north param 2}{
        \southwest \pgf@xa=\pgf@x
        \northeast \pgf@x=\pgf@xa
        \pgfmathsetlength\@tempdima{\functionwidth - \functionnorthportwidth}
        \advance\pgf@x by .5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port sep} + \pgfkeysvalueof{/function/north port width}}
        \advance\pgf@x by 1.5\@tempdima
        \advance\pgf@y by \northportoffset
    }

    \anchor{east param 1}{
        \northeast
        \pgfmathsetlength\@tempdima{\functionheight - \functioneastportheight}
        \advance\pgf@y by -.5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port sep} + \pgfkeysvalueof{/function/east port height}}
        \advance\pgf@y by -.5\@tempdima
        \advance\pgf@x by \eastportoffset
    }
    \anchor{east param 2}{
        \northeast
        \pgfmathsetlength\@tempdima{\functionheight - \functioneastportheight}
        \advance\pgf@y by -.5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port sep} + \pgfkeysvalueof{/function/east port height}}
        \advance\pgf@y by -1.5\@tempdima
        \advance\pgf@x by \eastportoffset
    }
    \anchor{south param 1}{
        \southwest
        \pgfmathsetlength\@tempdima{\functionwidth - \functionsouthportwidth}
        \advance\pgf@x by .5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port sep} + \pgfkeysvalueof{/function/east port height}}
        \advance\pgf@x by .5\@tempdima
        \advance\pgf@y by \southportoffset
    }
    \anchor{south param 2}{
        \southwest
        \pgfmathsetlength\@tempdima{\functionwidth - \functionsouthportwidth}
        \advance\pgf@x by .5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port sep} + \pgfkeysvalueof{/function/east port height}}
        \advance\pgf@x by 1.5\@tempdima
        \advance\pgf@y by \southportoffset
    }
    \anchor{west param 1}{
        \southwest \pgf@xa=\pgf@x
        \northeast \pgf@x=\pgf@xa
        \pgfmathsetlength\@tempdima{\functionheight - \functionwestportheight}
        \advance\pgf@y by -.5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port sep} + \pgfkeysvalueof{/function/west port height}}
        \advance\pgf@y by -.5\@tempdima
        \advance\pgf@x by \westportoffset
    }
    \anchor{west param 2}{
        \southwest \pgf@xa=\pgf@x
        \northeast \pgf@x=\pgf@xa
        \pgfmathsetlength\@tempdima{\functionheight - \functionwestportheight}
        \advance\pgf@y by -.5\@tempdima % start of north params
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port sep} + \pgfkeysvalueof{/function/west port height}}
        \advance\pgf@y by -1.5\@tempdima
        \advance\pgf@x by \westportoffset
    }

    \backgroundpath{%
        \southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
        \pgf@xc=\pgf@xa
        \pgf@yc=\pgf@yb
        % north
        \pgfpathmoveto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/north port}>0
        \pgfmathsetlength\@tempdima{\functionwidth - \functionnorthportwidth}
        \advance\pgf@xc by .5\@tempdima % start of north ports
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/north port sep}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/north port}}{%
            \advance\pgf@xc by .5\@tempdima
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \port{\pgfkeysvalueof{/function/north port width}}
            \pgftransformreset
            \global\advance\pgf@xc by \pgfkeysvalueof{/function/north port width}
            \global\advance\pgf@xc by .5\@tempdima
        }
        \fi
        % east
        \pgf@xc=\pgf@xb
        \pgf@yc=\pgf@yb
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/east port}>0
        \pgfmathsetlength\@tempdima{\functionheight - \functioneastportheight}
        \advance\pgf@yc by -.5\@tempdima % start of east ports
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/east port sep}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/east port}}{%
            \advance\pgf@yc by -.5\@tempdima
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgftransformrotate{-90}
            \port{\pgfkeysvalueof{/function/east port height}}
            \pgftransformreset
            \global\advance\pgf@yc by -\pgfkeysvalueof{/function/east port height}
            \global\advance\pgf@yc by -.5\@tempdima
        }
        \fi
        % south
        \pgf@xc=\pgf@xb
        \pgf@yc=\pgf@ya
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/south port}>0
        \pgfmathsetlength\@tempdima{\functionwidth - \functionsouthportwidth}
        \advance\pgf@xc by -.5\@tempdima % start of south ports
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/south port sep}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/south port}}{%
            \advance\pgf@xc by -.5\@tempdima
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgftransformscale{-1}
            \port{\pgfkeysvalueof{/function/south port width}}
            \pgftransformreset
            \global\advance\pgf@xc by -\pgfkeysvalueof{/function/south port width}
            \global\advance\pgf@xc by -.5\@tempdima
        }
        \fi
        % west
        \pgf@xc=\pgf@xa
        \pgf@yc=\pgf@ya
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/west port}>0
        \pgfmathsetlength\@tempdima{\functionheight - \functionwestportheight}
        \advance\pgf@yc by .5\@tempdima % start of west ports
        \pgfmathsetlength\@tempdima{\pgfkeysvalueof{/function/west port sep}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/west port}}{%
            \advance\pgf@yc by .5\@tempdima
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgftransformrotate{90}
            \port{\pgfkeysvalueof{/function/west port height}}
            \pgftransformreset
            \global\advance\pgf@yc by \pgfkeysvalueof{/function/west port height}
            \global\advance\pgf@yc by .5\@tempdima
        }
        \fi
        \pgfpathclose
        \pgfusepath{stroke}
    }
}
\makeatother
