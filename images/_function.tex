\makeatletter

\pgfkeys{
    /function/.cd,
    north port/.initial=1,
    south port/.initial=1,
    east port/.initial=0,
    west port/.initial=0,
}

\pgfdeclareshape{function}{%
    \inheritsavedanchors[from=rectangle]
    \inheritanchor[from=rectangle]{north east}
    \inheritanchor[from=rectangle]{north west}
    \inheritanchor[from=rectangle]{south east}
    \inheritanchor[from=rectangle]{south west}
    \savedanchor\southwest{%
        % box width
        \pgf@x=\the\wd\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerxsep}
        \advance\pgf@x by 2\pgf@xa%
        % is width < min width?
        \setlength\pgf@xa{\pgfshapeminwidth}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < north port width
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/north port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < south port width
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/south port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % + outer sep
        \setlength\pgf@xa{\pgfshapeouterxsep}%
        %
        \advance\pgf@x by 2\pgf@xa%
        \pgf@x = -.5\pgf@x
        \advance\pgf@x by .5\wd\pgfnodeparttextbox
        % box height
        \pgf@y=\the\ht\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@ya{\pgfshapeinnerysep}
        \advance\pgf@y by 2\pgf@ya%
        % is height < min height?
        \setlength\pgf@ya{\pgfshapeminheight}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < east port height
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/east port} * 4mm}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < west port height
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/west port} * 4mm}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % + outer sep
        \setlength\pgf@ya{\pgfshapeouterysep}%
        %
        \advance\pgf@y by 2\pgf@ya%
        \pgf@y = -.5\pgf@y
        \advance\pgf@y by .5\ht\pgfnodeparttextbox
    }
    \savedanchor\northeast{%
        % box width
        \pgf@x=\the\wd\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerxsep}
        \advance\pgf@x by 2\pgf@xa%
        % is width < min width?
        \setlength\pgf@xa{\pgfshapeminwidth}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < north port width
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/north port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < south port width
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/south port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % + outer sep
        \setlength\pgf@xa{\pgfshapeouterxsep}%
        %
        \advance\pgf@x by 2\pgf@xa%
        \pgf@x = .5\pgf@x
        \advance\pgf@x by .5\wd\pgfnodeparttextbox
        %
        % box height
        \pgf@y=\the\ht\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@ya{\pgfshapeinnerysep}
        \advance\pgf@y by 2\pgf@ya%
        % is height < min height?
        \setlength\pgf@ya{\pgfshapeminheight}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < east port height
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/east port} * 4mm}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % is height < west port height
        \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/function/west port} * 4mm}
        \ifdim\pgf@y<\pgf@ya \pgf@y=\pgf@ya \fi
        % + outer sep
        \setlength\pgf@ya{\pgfshapeouterysep}%
        %
        \advance\pgf@y by 2\pgf@ya%
        \pgf@y = .5\pgf@y
        \advance\pgf@y by .5\ht\pgfnodeparttextbox
    }
    \savedanchor\centerpoint{%
        \pgf@x = .5\wd\pgfnodeparttextbox
        \pgf@y = .5\ht\pgfnodeparttextbox
    }
    \saveddimen\functionwidth{%
        % box width
        \pgf@x=\the\wd\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerxsep}
        \advance\pgf@x by 2\pgf@xa%
        % is width < min width?
        \setlength\pgf@xa{\pgfshapeminwidth}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < north port width
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/north port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is width < south port width
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/south port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
    }
    \saveddimen\functionheight{%
        % box height
        \pgf@x=\the\ht\pgfnodeparttextbox
        % + inner sep
        \setlength\pgf@xa{\pgfshapeinnerysep}
        \advance\pgf@x by 2\pgf@xa%
        % is height < min height?
        \setlength\pgf@xa{\pgfshapeminheight}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is height < east port height
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/east port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
        % is height < west port height
        \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/function/west port} * 4mm}
        \ifdim\pgf@x<\pgf@xa \pgf@x=\pgf@xa \fi
    }
    \saveddimen\northportlength{%
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/north port} * 4mm}
    }
    \saveddimen\southportlength{%
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/south port} * 4mm}
    }
    \saveddimen\eastportlength{%
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/east port} * 4mm}
    }
    \saveddimen\westportlength{%
        \pgfmathsetlength\pgf@x{\pgfkeysvalueof{/function/west port} * 4mm}
    }
    \saveddimen\northportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/north port}>0 \advance\pgf@x by 1.5mm \fi
    }
    \saveddimen\southportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/south port}>0 \advance\pgf@x by -1.5mm \fi
    }
    \saveddimen\eastportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/east port}>0 \advance\pgf@x by 1.5mm \fi
    }
    \saveddimen\westportoffset{%
        \pgf@x=\z@
        \ifnum\pgfkeysvalueof{/function/west port}>0 \advance\pgf@x by -1.5mm \fi
    }
    \anchor{center}{%
        \centerpoint
    }
    \anchor{north}{%
        \northeast \@tempdimb=\pgf@x \@tempdima=\pgf@y
        \southwest 
        \pgfmathsetlength\pgf@x{(\pgf@x + \@tempdimb) / 2}
        \pgf@y=\@tempdima
        \advance\pgf@y by \northportoffset
    }
    \anchor{in}{%
        \northeast \@tempdima=\pgf@x \@tempdimb=\pgf@y
        \southwest 
        \pgfmathsetlength\pgf@x{(\pgf@x + \@tempdima) / 2}
        \pgf@y=\@tempdimb
        \advance\pgf@y by \northportoffset
    }
    \anchor{south}{%
        \northeast \@tempdimb=\pgf@x
        \southwest \@tempdima=\pgf@y
        \pgfmathsetlength\pgf@x{(\pgf@x + \@tempdimb) / 2}
        \pgf@y=\@tempdima
        \advance\pgf@y by \southportoffset
    }
    \anchor{out}{%
        \northeast \@tempdimb=\pgf@x
        \southwest \@tempdima=\pgf@y
        \pgfmathsetlength\pgf@x{(\pgf@x + \@tempdimb) / 2}
        \pgf@y=\@tempdima
        \advance\pgf@y by \southportoffset
    }
    \anchor{east}{%
        \southwest \@tempdima=\pgf@y
        \northeast
        \pgfmathsetlength\pgf@y{(\pgf@y + \@tempdima) / 2}
        \advance\pgf@x by \eastportoffset
    }
    \anchor{west}{%
        \northeast \@tempdima=\pgf@y
        \southwest
        \pgfmathsetlength\pgf@y{(\pgf@y + \@tempdima) / 2}
        \advance\pgf@x by \westportoffset
    }
    \backgroundpath{%
        \southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
        \northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
        \pgf@xc=\pgf@xa
        \pgf@yc=\pgf@yb
        % north
        \pgfpathmoveto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/north port}>0
        \pgfmathsetlength\@tempdima{(\functionwidth - \northportlength)}
        \advance\pgf@xc by .5\@tempdima
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/north port}}{%
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathlineto{\pgfqpoint{1mm}{\z@}}
            \pgfpathlineto{\pgfqpoint{1mm}{0.5mm}}
            \pgfpathlineto{\pgfqpoint{0.5mm}{1mm}}
            \pgfpathlineto{\pgfqpoint{0.5mm}{1.5mm}}
            \pgfpathlineto{\pgfqpoint{3.5mm}{1.5mm}}
            \pgfpathlineto{\pgfqpoint{3.5mm}{1mm}}
            \pgfpathlineto{\pgfqpoint{3mm}{0.5mm}}
            \pgfpathlineto{\pgfqpoint{3mm}{\z@}}
            \pgfpathlineto{\pgfqpoint{4mm}{\z@}}
            \pgftransformreset
            \global\advance\pgf@xc by 4mm
        }
        \fi
        % east
        \pgf@xc=\pgf@xb
        \pgf@yc=\pgf@yb
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/east port}>0
        \pgfmathsetlength\@tempdima{(\functionheight - \eastportlength)}
        \advance\pgf@yc by -.5\@tempdima
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/east port}}{%
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathlineto{\pgfqpoint{\z@}{-1mm}}
            \pgfpathlineto{\pgfqpoint{0.5mm}{-1mm}}
            \pgfpathlineto{\pgfqpoint{1mm}{-0.5mm}}
            \pgfpathlineto{\pgfqpoint{1.5mm}{-0.5mm}}
            \pgfpathlineto{\pgfqpoint{1.5mm}{-3.5mm}}
            \pgfpathlineto{\pgfqpoint{1mm}{-3.5mm}}
            \pgfpathlineto{\pgfqpoint{0.5mm}{-3mm}}
            \pgfpathlineto{\pgfqpoint{\z@}{-3mm}}
            \pgfpathlineto{\pgfqpoint{\z@}{-4mm}}
            \pgftransformreset
            \global\advance\pgf@yc by -4mm
        }
        \fi
        % south
        \pgf@xc=\pgf@xb
        \pgf@yc=\pgf@ya
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/south port}>0
        \pgfmathsetlength\@tempdima{(\functionwidth - \southportlength)}
        \advance\pgf@xc by -.5\@tempdima
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/south port}}{%
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathlineto{\pgfqpoint{-1mm}{\z@}}
            \pgfpathlineto{\pgfqpoint{-1mm}{-0.5mm}}
            \pgfpathlineto{\pgfqpoint{-0.5mm}{-1mm}}
            \pgfpathlineto{\pgfqpoint{-0.5mm}{-1.5mm}}
            \pgfpathlineto{\pgfqpoint{-3.5mm}{-1.5mm}}
            \pgfpathlineto{\pgfqpoint{-3.5mm}{-1mm}}
            \pgfpathlineto{\pgfqpoint{-3mm}{-0.5mm}}
            \pgfpathlineto{\pgfqpoint{-3mm}{\z@}}
            \pgfpathlineto{\pgfqpoint{-4mm}{\z@}}
            \pgftransformreset
            \global\advance\pgf@xc by -4mm
        }
        \fi
        % west
        \pgf@xc=\pgf@xa
        \pgf@yc=\pgf@ya
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \ifnum\pgfkeysvalueof{/function/west port}>0
        \pgfmathsetlength\@tempdima{(\functionheight - \westportlength)}
        \advance\pgf@yc by .5\@tempdima
        \pgfpathlineto{\pgfqpoint{\pgf@xc}{\pgf@yc}}
        \foreach \i in {1,...,\pgfkeysvalueof{/function/west port}}{%
            \pgftransformshift{\pgfqpoint{\pgf@xc}{\pgf@yc}}
            \pgfpathlineto{\pgfqpoint{\z@}{1mm}}
            \pgfpathlineto{\pgfqpoint{-0.5mm}{1mm}}
            \pgfpathlineto{\pgfqpoint{-1mm}{0.5mm}}
            \pgfpathlineto{\pgfqpoint{-1.5mm}{0.5mm}}
            \pgfpathlineto{\pgfqpoint{-1.5mm}{3.5mm}}
            \pgfpathlineto{\pgfqpoint{-1mm}{3.5mm}}
            \pgfpathlineto{\pgfqpoint{-0.5mm}{3mm}}
            \pgfpathlineto{\pgfqpoint{\z@}{3mm}}
            \pgfpathlineto{\pgfqpoint{\z@}{4mm}}
            \pgftransformreset
            \global\advance\pgf@yc by 4mm
        }
        \fi
        \pgfpathclose
        \pgfusepath{stroke}
    }
}
\makeatother
