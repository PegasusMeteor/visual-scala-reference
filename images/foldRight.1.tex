---
---

\tikzset{op/.style={
    subfunction,
    inner xsep=.1\masterunit,
    /function/west io=1,
    /function/north io=2,
    /function/north io sep=.1\masterunit,
    /function/south io=0,
}}

\matrix (A) [collection] {
    \node (a1) {$a_1$}; &
    \elementsbetween &
    \node (ai) {$a_i$}; &
    \elementsbetween &
    \node (an-1) {$a_{n - 1}$}; &
    \node (an) {$a_n$}; &
\\ };

\node (z) [element, right=.5 of A] {\texttt{z}};

\foreach \i in {n,n-1,i,1}{
    \node (f\i) [op, below=1 of a\i, anchor=north io 1] {\texttt{op}};
    \draw [flow ->] (a\i) -- (f\i.north io 1);
}

\node (b) [element, left=.5 of f1] {$b$};

\coordinate (x) at ($ (fn.north io 2)!.5!(an.south) $);
\coordinate (rule) at (fn.north io 2 |- x);

\draw [flow ->] (fn.west io 1) -- ($ (fn.west)!.5!(fn-1.east) $) -- (\currentcoordinate |- rule) -| (fn-1.north io 2);
\draw [flow ->, dashed] (fn-1.west io 1) -- ++(-.25, 0) -- (\currentcoordinate |- rule) -- +(-.5, 0);
\draw [<- flow, dashed] (fi.north io 2) -- (fi.north io 2 |- rule) -- +(.5, 0);
\draw [flow ->, dashed] (fi.west io 1) -- ++(-.25, 0) -- (\currentcoordinate |- rule) -- +(-.5, 0);
\draw [<- flow, dashed] (f1.north io 2) -- (f1.north io 2 |- rule) -- +(.5, 0);

\draw [flow ->] (z) |- (rule) -- (fn.north io 2);
\draw [flow ->] (f1.west io 1) -- (b);
