\input{_header.tex}

\matrix (A) [collection] {
  \node (a1)   {$a_1$};     &
  \node (a2)   {$a_2$};     &
  \node (a3)   {$a_3$};     &
  \helem{between}                 &
  \node (ai)   {$a_i$};     &
  \node (ai+1) {$a_{i+1}$}; &
  \helem{between}                 &
  \node (an)   {$a_n$};     \\
};

\node [big arrow, below=\cellheight - .5\bigarrowwidth of A, anchor=west, rotate=-90];

\foreach \i/\k in {
  1/k_1,
  2/k_2,
  3/k_1,
  i/k_m,
  i+1/k_2,
  n/k_m}
{
  \path
    node (f\i) [predicate evaluation, above=.5 of a\i] {$\param{f}(a_{\i})$}
    (a\i) [predicate evaluation edge] -- (f\i);
    \path node (fk\i) [predicate evaluation, above=.5 of f\i] {$\k$}
    (fk\i) [predicate evaluation edge] -- (f\i.north);
}

\matrix (K) [map, below left=2\cellheight and 2 of A.south] {
  \node (k1) {$k_1$}; \\
  \node (k2) {$k_2$}; \\
  \velem{between}          \\
  \node (km) {$k_m$}; \\
};

\matrix (K1) [small collection, right=1 of k1.east] {
  \node             {$a_1$};  &
  \node             {$a_3$};  &
  \helem[\smallcolfactor\elementswidth]{after}           \\
};

\matrix (K2) [small collection, right=1 of k2.east] {
  \node             {$a_2$};     &
  \helem[\smallcolfactor\elementswidth]{between}              &
  \node             {$a_{i+1}$}; &
  \helem[\smallcolfactor\elementswidth]{after}              \\
};

\matrix (Km) [small collection, right=1 of km.east] {
  \helem[\smallcolfactor\elementswidth]{before}              &
  \node             {$a_i$}; &
  \helem[\smallcolfactor\elementswidth]{between}          &
  \node             {$a_n$}; \\
};

\foreach \i in {1, 2, m} {
  \draw (k\i) [maps to] -- (K\i);
}

\input{_footer.tex}
