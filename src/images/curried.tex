\input{_header.tex}

\begin{scope}
  \tikzstyle{every node}=[/function/out width=1cm, /function/out sep=0mm, anchor=in]
  \node (g1) [function] {$f^{\prime}$};
  \node (g2) [function, below=\cellheight of g1.out] {};
  \node (gn) [function, below=1.5\cellheight of g2.out, /function/out width=4mm] {};
\end{scope}

\draw
  ($ (g1.out 1) - (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (g2.north west)
  ($ (g1.out 1) + (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (g2.north east);

\draw [middle dots] ($ (g2.out 1) - (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (gn.north west);
\draw [middle dots] ($ (g2.out 1) + (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (gn.north east);

\foreach \i in {1, 2, n} {%
  \node (a\i) [above right=\cellheight and \cellwidth of g\i.in 1] {$a_\i$};
  \draw [smooth arrow, erase] (a\i.south) to (g\i.in 1);
}

\node (b) [below=\cellheight of gn.out 1] {$b$};
\draw [arrow] (gn.out 1) -- (b);

\node (f) [left=2\cellwidth of g1, function, /function/in=4] {$f$};
\foreach \i/\n in {1/1, 2/2, 4/n} {%
  \node (i\i) [above=1 of f.in \i] {$a_\n$};
  \draw [arrow] (i\i) -- (f.in \i);
}

\node (b) [below=\cellheight of f.out 1] {$b$};
\draw [arrow] (f.out 1) -- (b);

% dirty ... hack
\fill ($ (f.in 2) + (4mm, -3mm) $) [white] rectangle +(8mm, 4mm);
\draw [line width=0.4mm, dotted] ($ (f.in 2) + (4mm, -2mm) $) -- +(8mm, 0);

\node [big arrow, right=\cellheight - .5\bigarrowwidth of f];

\input{_footer.tex}
