\input{_header.tex}

\matrix (A) [collection, name prefix=a] {
  \node (1) {$a_1$};       &
  \node (2) {$a_2$};       &
  \ellipsis;               &
  \node (i) {$a_i$};       &
  \ellipsis;               &
  \node (n-1) {$a_{n-1}$}; &
  \node (n) {$a_n$};       \\
};

\matrix (B) [collection, matrix anchor=bz.east, below of=A, node distance=7cm] at (a1.west) {
  \node (bz)   {$\param{z}$}; &
  \node (b1)   {$z_1$};        &
  \node (b2)   {$z_2$};        &
  \ellipsis;                   &
  \node (bi)   {$z_i$};        &
  \ellipsis;                   &
  \node (bn-1) {$z_n$};        &
  \node (bn)   {$b$};          \\
};

\node (z) [above=61mm of bz] {\param{z}};

\matrix [below=16mm of A, column sep=1cm] {
  \node (op11) [predicate] {$\param{op}(\textrm{z}, a_1)$}; &
  \node (op12) [predicate] {$\param{op}(a_1, a_2)$};        &
  \coordinate (op1s1); &
  \node (op13) [predicate] {$\param{op}(\textrm{z}, a_i)$}; &
  \coordinate (op1s2); &
  \node (op14) [predicate] {$\param{op}(a_{n-1}, a_n)$}; \\
};

\matrix [below=35mm of A, column sep=1cm] {
  \node (op21) [predicate] {$\param{op}(z_1, z_2)$}; &
  \node (op22) [predicate] {$\param{op}(z_{i-1}, z_i)$};        &
  \node (op23) [predicate] {$\param{op}(z_{n-1}, z_n)$}; \\
};

\begin{scope}
  \tikzstyle{every path}=[arrow, smooth]
  \draw (z) [white border] to (op11.100);
  \draw (z) [white border, in=120] to (op13.100);

  \draw (a1) [white border] to (op11.40);
  \draw (a1) [white border] to (op12.100);

  \draw (a2) [white border] to (op12.40);

  \draw (ai) [white border] to (op13.40);

  \draw (an-1) [white border] to (op14.100);
  \draw (an) [white border] to (op14.30);

  \draw (op11) [white border] to (op21.100);
  \draw (op12) [white border] to (op21.40);

  \draw ([yshift=-1em] op1s1) [start dots] to (op22.100);
  \draw (op13) [white border] to (op22.25);

  \draw ([yshift=-1em] op1s2) [start dots] to (op23.100);
  \draw (op14) [white border] to (op23.25);
\end{scope}

\foreach \i in {z,1,2,i,n-1,n} {
  \draw ([yshift=10mm] b\i.north) [arrow, start dots] -- (b\i.north);
}

% \node (f1) [above=4cm of b1] {$\param{op}(\textrm{z}, a_1)$};
% \node (f2) [above=3cm of b2] {$\param{op}(z1, a_2)$};
% \node (fi) [above=2cm of bi] {$\param{op}(z_{i-1}, a_i)$};
% \node (fn) [above=1cm of bn] {$\param{op}(z_{n-1}, a_n)$};
% 
% \begin{scope}
%   \tikzstyle{every path}=[arrow, smooth]
%   \draw (z) edge (bz) edge ([xshift=-0.2em] f1.north);
% 
%   \draw (a1) to ([xshift=0.8em] f1.north);
%   \draw (f1) edge (b1) edge ([xshift=-0.4em] f2.north);
% 
%   \draw (a2) to ([xshift=0.8em] f2.north);
%   \draw (f2) edge (b2) edge [middotted] ([xshift=-0.2em] fi.north);
% 
%   \draw (ai) to ([xshift=1.4em] fi.north);
%   \draw (fi) edge (bi) edge [middotted] ([xshift=-0.2em] fn.north);
% 
%   \draw (an) to ([xshift=1.4em] fn.north);
%   \draw (fn) edge (bn);
% \end{scope}

\input{_footer.tex}
