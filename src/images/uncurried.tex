\input{_header.tex}

\begin{scope}
  \tikzstyle{every node}=[/function/out width=1cm, /function/out sep=0mm, anchor=in]
  \node (f1) [function] {$\param{f}$};
  \node (f2) [function, below=\cellheight of f1.out] {};
  \node (fn) [function, below=1.5\cellheight of f2.out, /function/out width=4mm] {};
\end{scope}

\draw
  ($ (f1.out 1) - (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (f2.north west)
  ($ (f1.out 1) + (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (f2.north east);

\draw [middle dots] ($ (f2.out 1) - (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (fn.north west);
\draw [middle dots] ($ (f2.out 1) + (4mm, 0) $) .. controls +(0, -4mm) and +(0, 4mm) .. (fn.north east);

\foreach \i in {1, 2, n} {%
  \node (a\i) [above left=\cellheight and \cellwidth of f\i.in 1] {$a_\i$};
  \draw [smooth arrow, erase] (a\i.south) to (f\i.in 1);
}

\node (b) [below=\cellheight of fn.out 1] {$b$};
\draw [arrow] (fn.out 1) -- (b);

\node (g) [right=2\cellwidth of f1, function, /function/in=4] {$\param{f}^{\prime}$};
\foreach \i/\n in {1/1, 2/2, 4/n} {%
  \node (i\i) [above=1 of g.in \i] {$a_\n$};
  \draw [arrow] (i\i) -- (g.in \i);
}

\node (b) [below=\cellheight of g.out 1] {$b$};
\draw [arrow] (g.out 1) -- (b);

% dirty ... hack
\fill ($ (g.in 2) + (4mm, -3mm) $) [white] rectangle +(8mm, 4mm);
\draw [line width=0.4mm, dotted] ($ (g.in 2) + (4mm, -2mm) $) -- +(8mm, 0);

\node [big arrow, right=\cellheight - .5\bigarrowwidth of f1];

\input{_footer.tex}
